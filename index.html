<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern QR Scan - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #edf2f7; }
        #reader { border: none !important; border-radius: 1rem; }
        #reader__dashboard_section_csr button { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á lib */
        .status-loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .bg-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="bg-indigo-900 text-white p-4 shadow-xl mb-6 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">‚ö°</span>
                <h1 class="font-bold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2026</h1>
            </div>
            <div id="clock" class="text-sm font-mono bg-black/20 px-3 py-1 rounded-full">00:00:00</div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-7 space-y-4">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-200">
                <div class="flex border-b">
                    <button onclick="switchMode('camera')" id="btnCam" class="flex-1 py-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50">
                        üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
                    </button>
                    <button onclick="switchMode('file')" id="btnFile" class="flex-1 py-4 font-semibold text-gray-500 hover:bg-gray-50">
                        üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    </button>
                </div>

                <div class="p-4">
                    <div id="cameraArea" class="relative bg-black rounded-2xl overflow-hidden aspect-video flex items-center justify-center">
                        <div id="reader" class="w-full"></div>
                        <div id="scanMsg" class="absolute bottom-4 left-0 right-0 text-center text-white text-sm bg-black/50 py-2">
                            ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...
                        </div>
                    </div>

                    <div id="fileArea" class="hidden py-10 border-2 border-dashed border-gray-300 rounded-2xl text-center bg-gray-50">
                        <input type="file" id="qr-input-file" accept="image/*" class="hidden">
                        <label for="qr-input-file" class="cursor-pointer">
                            <div class="text-5xl mb-3">üñºÔ∏è</div>
                            <p class="text-gray-600 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR Code</p>
                            <p class="text-gray-400 text-xs mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, WEBP</p>
                        </label>
                    </div>
                </div>

                <div class="p-4 bg-gray-50 flex gap-2">
                    <button onclick="setDay(1)" id="day1" class="flex-1 py-3 rounded-xl font-bold transition-all bg-indigo-600 text-white shadow-md">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</button>
                    <button onclick="setDay(2)" id="day2" class="flex-1 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 border border-gray-200">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2</button>
                </div>
            </div>

            <div id="loader" class="hidden bg-white p-4 rounded-2xl shadow-md border-l-4 border-yellow-400 flex items-center gap-4 status-loading">
                <div class="w-5 h-5 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-yellow-700 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</span>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-4">
            <div id="resultDisplay" class="bg-white rounded-3xl p-6 shadow-xl border-2 border-transparent transition-all min-h-[300px] flex flex-col items-center justify-center text-center">
                <div id="resDefault">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-4xl mb-4 text-gray-300">üë§</div>
                    <h3 class="text-xl font-bold text-gray-400">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h3>
                    <p class="text-gray-400 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                </div>
                
                <div id="resContent" class="hidden w-full">
                    <div class="relative inline-block mb-4">
                        <img id="resImg" src="" class="w-32 h-32 rounded-3xl object-cover border-4 border-white shadow-lg mx-auto bg-gray-100">
                        <div class="absolute -bottom-2 -right-2 bg-green-500 text-white p-1.5 rounded-full shadow-lg">‚úÖ</div>
                    </div>
                    <div class="space-y-1">
                        <p id="resId" class="text-indigo-600 font-mono font-bold tracking-widest text-lg">ID: -</p>
                        <h2 id="resName" class="text-2xl font-bold text-gray-800 leading-tight">-</h2>
                        <p id="resDept" class="text-gray-500 bg-gray-100 px-4 py-1 rounded-full inline-block text-sm mt-2">-</p>
                    </div>
                    <div class="mt-6 pt-4 border-t border-dashed w-full text-green-600 font-bold flex justify-center items-center gap-2">
                        <span>‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ß‡∏•‡∏≤:</span>
                        <span id="resTime">00:00</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
                <div class="p-4 bg-gray-800 text-white flex justify-between items-center">
                    <h3 class="font-bold text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <span id="count" class="bg-white/20 text-[10px] px-2 py-0.5 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div id="history" class="p-2 max-h-[350px] overflow-y-auto space-y-2">
                    </div>
            </div>
        </div>
    </main>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzfOu3S0v5_u0XJi-IdwTIx6HecySKswYFt05wjfCBbu5pyEYy2LPsFSUkL7d4dmdVK/exec";
        let html5QrCode;
        let currentDay = 1;
        let isBusy = false;

        // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏•‡∏±‡∏ö (‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏ü‡∏•‡πå)
        function switchMode(mode) {
            const camArea = document.getElementById('cameraArea');
            const fileArea = document.getElementById('fileArea');
            const btnCam = document.getElementById('btnCam');
            const btnFile = document.getElementById('btnFile');

            if (mode === 'camera') {
                camArea.classList.remove('hidden');
                fileArea.classList.add('hidden');
                btnCam.className = "flex-1 py-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50";
                btnFile.className = "flex-1 py-4 font-semibold text-gray-500 hover:bg-gray-50";
                startCamera();
            } else {
                camArea.classList.add('hidden');
                fileArea.classList.remove('hidden');
                btnFile.className = "flex-1 py-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50";
                btnCam.className = "flex-1 py-4 font-semibold text-gray-500 hover:bg-gray-50";
                if(html5QrCode) html5QrCode.stop();
            }
        }

        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function startCamera() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
        }

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
        document.getElementById('qr-input-file').addEventListener('change', e => {
            if (e.target.files.length == 0) return;
            const imageFile = e.target.files[0];
            const fileScanner = new Html5Qrcode("reader"); // ‡πÉ‡∏ä‡πâ instance ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
            setLoading(true);
            fileScanner.scanFile(imageFile, true)
                .then(onScanSuccess)
                .catch(err => {
                    setLoading(false);
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code', '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR ‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î', 'error');
                });
        });

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        async function onScanSuccess(decodedText) {
            if (isBusy) return;
            isBusy = true;
            setLoading(true);

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'recordAttendance', data: { text: decodedText, day: currentDay } })
                });
                const result = await response.json();

                if (result.success) {
                    showResult(result.user);
                    updateHistory();
                } else {
                    Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: result.message, timer: 2000 });
                }
            } catch (err) {
                console.error(err);
            } finally {
                setLoading(false);
                setTimeout(() => { isBusy = false; }, 2000);
            }
        }

        function showResult(user) {
            document.getElementById('resDefault').classList.add('hidden');
            document.getElementById('resContent').classList.remove('hidden');
            document.getElementById('resultDisplay').className = "bg-white rounded-3xl p-6 shadow-xl border-2 border-green-500 transition-all scale-105";
            
            document.getElementById('resName').innerText = user.name;
            document.getElementById('resId').innerText = `ID: ${user.id}`;
            document.getElementById('resDept').innerText = user.dept;
            document.getElementById('resTime').innerText = user.time;
            document.getElementById('resImg').src = user.img ? user.img : "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        }

        function setLoading(status) {
            const loader = document.getElementById('loader');
            const scanMsg = document.getElementById('scanMsg');
            if (status) {
                loader.classList.remove('hidden');
                scanMsg.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server...";
            } else {
                loader.classList.add('hidden');
                scanMsg.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...";
            }
        }

        function setDay(day) {
            currentDay = day;
            document.getElementById('day1').className = day === 1 ? "flex-1 py-3 rounded-xl font-bold transition-all bg-indigo-600 text-white shadow-md" : "flex-1 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 border border-gray-200";
            document.getElementById('day2').className = day === 2 ? "flex-1 py-3 rounded-xl font-bold transition-all bg-indigo-600 text-white shadow-md" : "flex-1 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 border border-gray-200";
            updateHistory();
        }

        async function updateHistory() {
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getRecentRecords', data: { day: currentDay } })
                });
                const result = await res.json();
                const list = document.getElementById('history');
                const count = document.getElementById('count');
                if (result.success) {
                    count.innerText = `${result.records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    list.innerHTML = result.records.map(rec => `
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-2xl border border-gray-100">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-[10px] font-bold text-indigo-700">${rec.id}</div>
                            <div class="flex-grow">
                                <div class="text-xs font-bold text-gray-700">${rec.name}</div>
                                <div class="text-[10px] text-gray-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô: ${rec.time}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {}
        }

        // ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÅ‡∏ö‡∏ö Real-time
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH');
        }, 1000);

        window.onload = () => {
            startCamera();
            updateHistory();
        };
    </script>
</body>
</html>
