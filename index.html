<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QR Scanner Nurse Chula 2026</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #002d5f; --accent: #6610f2; --success: #00c853; }
    body { font-family: 'Sarabun', sans-serif; background: #f8f9fa; color: #1a1a1a; margin: 0; }

    /* Navbar */
    .app-header { background: var(--primary); color: white; padding: 12px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    /* Scanner UI */
    .scanner-box {
      position: relative; background: #000; border-radius: 20px; overflow: hidden;
      height: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) { .scanner-box { height: 50vh; border-radius: 0 0 20px 20px; } }

    #reader { width: 100% !important; height: 100% !important; border: none !important; }
    #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

    /* Overlay Scan Line */
    .scan-guide {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 240px; height: 240px; border: 2px solid rgba(255,255,255,0.2); border-radius: 30px;
      z-index: 5; pointer-events: none; box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
    }
    .scan-guide::after {
      content: ""; position: absolute; width: 100%; height: 2px; background: #00ff00;
      top: 0; animation: scanLine 2s infinite linear; box-shadow: 0 0 10px #00ff00;
    }
    @keyframes scanLine { 0% { top: 0; } 100% { top: 100%; } }

    /* User Info Card */
    .user-card {
      background: #fff; border-radius: 20px; padding: 20px;
      border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }
    .user-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    /* History */
    .history-item {
      background: #fff; border-radius: 12px; padding: 10px 15px; margin-bottom: 8px;
      display: flex; align-items: center; justify-content: space-between;
      border-left: 5px solid var(--success); font-size: 0.9rem;
    }

    .btn-custom { border-radius: 50px; padding: 12px 20px; font-weight: bold; transition: 0.3s; }
    .timer-progress { height: 4px; background: var(--success); width: 100%; transition: width 3s linear; }

    [v-cloak] { display: none; }
  </style>
</head>
<body>

<div id="app" v-cloak>
  <header class="app-header mb-3">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="fw-800"><i class="fa-solid fa-qrcode me-2"></i>ระบบสแกนเข้างาน 2569</span>
      <div class="small bg-white text-dark rounded-pill px-3 py-1 fw-bold">{{ currentTime }}</div>
    </div>
  </header>

  <div class="container">
    <div class="row g-3">
      
      <!-- โซนที่ 1: กล้องและการควบคุม -->
      <div class="col-lg-6">
        <div class="scanner-box mb-3">
          <div id="reader"></div>
          <div v-show="isScanning" class="scan-guide"></div>
          
          <div v-if="!isScanning && !scannedUser" class="h-100 d-flex flex-column align-items-center justify-content-center text-white p-4 text-center">
            <i class="fa-solid fa-camera fa-4x opacity-25 mb-3"></i>
            <h5>กล้องถูกปิดอยู่</h5>
            <p class="small opacity-50">กรุณากดปุ่ม "เริ่มสแกน" หรือ "อัปโหลดรูป"</p>
          </div>
        </div>

        <div class="card p-3 border-0 shadow-sm rounded-4">
          <!-- เลือกวัน -->
          <div class="btn-group w-100 mb-3 bg-light p-1 rounded-pill">
            <button class="btn btn-sm rounded-pill py-2" :class="scanDay === '1' ? 'btn-primary' : 'btn-light'" @click="changeDay('1')">วันที่ 1 (25 ส.ค.)</button>
            <button class="btn btn-sm rounded-pill py-2" :class="scanDay === '2' ? 'btn-primary' : 'btn-light'" @click="changeDay('2')">วันที่ 2 (26 ส.ค.)</button>
          </div>

          <!-- ปุ่มควบคุม -->
          <div class="row g-2">
            <div class="col-6">
              <button v-if="!isScanning" class="btn btn-primary btn-custom w-100" @click="startScanner" :disabled="loading">
                <i class="fa-solid fa-video me-2"></i>เริ่มสแกน
              </button>
              <button v-else class="btn btn-danger btn-custom w-100" @click="stopScanner">
                <i class="fa-solid fa-video-slash me-2"></i>ปิดกล้อง
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-outline-dark btn-custom w-100" @click="$refs.fileInput.click()" :disabled="loading">
                <i class="fa-solid fa-image me-2"></i>อัปโหลดรูป
              </button>
              <input type="file" ref="fileInput" class="d-none" accept="image/*" @change="handleFileUpload">
            </div>
          </div>
        </div>
      </div>

      <!-- โซนที่ 2: ผลลัพธ์และประวัติ -->
      <div class="col-lg-6">
        
        <!-- ข้อมูลคนปัจจุบัน -->
        <div class="user-card mb-3 position-relative overflow-hidden">
          <div v-if="scannedUser" class="animate__animated animate__fadeIn">
            <div class="d-flex align-items-center gap-3">
              <img :src="scannedUser.img || 'https://cdn-icons-png.flaticon.com/512/147/147144.png'" class="user-img">
              <div>
                <h4 class="fw-800 mb-1 text-primary">{{ scannedUser.name }}</h4>
                <div class="badge bg-success rounded-pill">ID: {{ scannedUser.id }}</div>
                <div class="small text-muted mt-1">{{ scannedUser.dept }}</div>
              </div>
            </div>
            <div class="mt-3">
               <div class="small text-muted mb-1 text-center">สแกนคนถัดไปอัตโนมัติใน 3 วินาที...</div>
               <div class="timer-progress"></div>
            </div>
          </div>
          <div v-else class="py-5 text-center opacity-25">
            <i class="fa-solid fa-user-check fa-4x"></i>
            <p class="mt-2 fw-bold">รอรับข้อมูลการสแกน...</p>
          </div>
        </div>

        <!-- รายการประวัติ -->
        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
          <h6 class="fw-800 mb-0"><i class="fa-solid fa-clock-rotate-left me-2"></i>5 รายการล่าสุด</h6>
          <button class="btn btn-sm btn-link text-decoration-none" @click="fetchHistory">อัปเดต</button>
        </div>
        <div class="history-list">
          <div v-for="rec in recentHistory" :key="rec.id" class="history-item animate__animated animate__fadeInLeft">
             <div class="fw-bold text-dark">{{ rec.name }} <span class="fw-normal text-muted small">(ID: {{rec.id}})</span></div>
             <span class="badge bg-light text-dark border">{{ rec.time }}</span>
          </div>
          <div v-if="recentHistory.length === 0" class="text-center py-3 text-muted small">ยังไม่มีข้อมูลวันนี้</div>
        </div>

      </div>
    </div>
  </div>

  <div v-if="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 9999;">
    <div class="text-center">
      <div class="spinner-border text-primary"></div>
      <div class="mt-2 fw-bold">กำลังประมวลผล...</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

<script>
const { createApp, ref, onMounted } = Vue;
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfOu3S0v5_u0XJi-IdwTIx6HecySKswYFt05wjfCBbu5pyEYy2LPsFSUkL7d4dmdVK/exec";

createApp({
  setup() {
    const isScanning = ref(false);
    const scanDay = ref('1');
    const scannedUser = ref(null);
    const recentHistory = ref([]);
    const currentTime = ref('');
    const loading = ref(false);
    let html5Qr = null;

    setInterval(() => { currentTime.value = new Date().toLocaleTimeString('th-TH'); }, 1000);

    const startScanner = async () => {
      if (!html5Qr) html5Qr = new Html5Qrcode("reader");
      if (html5Qr.isScanning) return;
      isScanning.value = true;
      scannedUser.value = null;
      try {
        await html5Qr.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, 
          (text) => {
            new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
            handleScanSuccess(text);
          }
        );
      } catch (err) { isScanning.value = false; }
    };

    const stopScanner = async () => {
      if (html5Qr && html5Qr.isScanning) {
        await html5Qr.stop();
        isScanning.value = false;
      }
    };

    const handleFileUpload = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      loading.value = true;
      if (!html5Qr) html5Qr = new Html5Qrcode("reader");
      
      try {
        if (html5Qr.isScanning) await html5Qr.stop();
        isScanning.value = false;
        
        const decodedText = await html5Qr.scanFile(file, true);
        new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
        handleScanSuccess(decodedText);
      } catch (err) {
        alert("ไม่พบ QR Code ในรูปภาพ กรุณาลองใหม่อีกครั้ง");
      } finally {
        loading.value = false;
        e.target.value = ''; // Reset input
      }
    };

    const handleScanSuccess = async (text) => {
      if (html5Qr && html5Qr.isScanning) await html5Qr.stop();
      isScanning.value = false;
      loading.value = true;
      
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify({ action: 'recordAttendance', data: { text, day: scanDay.value } })
        });
        const result = await res.json();

        if (result.success) {
          scannedUser.value = result.user;
          recentHistory.value.unshift(result.user);
          if (recentHistory.value.length > 5) recentHistory.value.pop();
          
          // Auto Resume กล้องใน 3 วินาที
          setTimeout(() => { startScanner(); }, 3000);
        } else {
          alert(result.message);
          startScanner();
        }
      } catch (e) { alert("เกิดข้อผิดพลาดในการเชื่อมต่อ"); startScanner(); }
      finally { loading.value = false; }
    };

    const changeDay = (day) => {
      scanDay.value = day;
      scannedUser.value = null;
      fetchHistory();
    };

    const fetchHistory = async () => {
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify({ action: 'getRecentRecords', data: { day: scanDay.value } })
        });
        const data = await res.json();
        if (data.success) recentHistory.value = data.records;
      } catch(e) {}
    };

    onMounted(() => fetchHistory());

    return { isScanning, scanDay, scannedUser, recentHistory, currentTime, loading, startScanner, stopScanner, handleFileUpload, changeDay, fetchHistory };
  }
}).mount('#app');
</script>
</body>
</html>
