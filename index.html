<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Check-in</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { font-family: 'Prompt', sans-serif; }</style>
</head>
<body class="bg-slate-50 min-h-screen p-4">
    <div id="main-content" class="max-w-md mx-auto space-y-4">
        <div class="bg-white p-6 rounded-3xl shadow-lg text-center">
            <h1 class="text-2xl font-bold text-indigo-600 mb-2">Smart QR Check-in</h1>
            <p id="staff-name" class="text-sm text-slate-500 italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà...</p>
        </div>

        <div class="grid grid-cols-2 gap-2 bg-slate-200 p-1 rounded-2xl">
            <button onclick="changeDay(1)" id="d1" class="bg-indigo-600 text-white py-2 rounded-xl font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</button>
            <button onclick="changeDay(2)" id="d2" class="py-2 rounded-xl font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2</button>
        </div>

        <button onclick="scanQR()" class="w-full bg-emerald-500 text-white py-8 rounded-3xl text-2xl font-bold shadow-lg active:scale-95 transition-all">
            üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR CODE
        </button>

        <div id="result" class="hidden bg-white p-6 rounded-3xl shadow-lg border-2 border-indigo-100 text-center">
            <img id="u-img" class="w-24 h-24 mx-auto rounded-full mb-4 border-4 border-indigo-50" src="">
            <h2 id="u-name" class="text-xl font-bold"></h2>
            <p id="u-id" class="text-indigo-600 font-mono"></p>
            <p id="u-time" class="text-green-600 font-bold mt-2"></p>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwiWK2OGyfZO8HyVKizYST4sCjgmkKMa5bZGT8Uh2uwLMa0GU9heiXDbq6epcRsZfov/exec";
        let day = 1;
        let staff = null;

        async function callGAS(action, data) {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action, data })
            });
            return await res.json();
        }

        async function init() {
            await liff.init({ liffId: "2009224948-SqUmr0cv" });
            if (!liff.isLoggedIn()) liff.login();
            const profile = await liff.getProfile();
            const res = await callGAS('checkStaffPrivilege', { userId: profile.userId });
            if (res.isAllowed) {
                staff = res;
                document.getElementById('staff-name').innerText = "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: " + res.name;
            } else {
                Swal.fire("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", "ID: " + profile.userId, "error");
            }
        }

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Script ‡πÉ‡∏ô index.html ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
async function scanQR() {
    const result = await liff.scanCodeV2();
    if (result.value) {
        processAttendance(result.value, false);
    }
}

async function processAttendance(qrText, confirmSkip) {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
    
    const res = await callGAS('recordAttendance', { 
        text: qrText, 
        day: day, 
        confirmSkip: confirmSkip, 
        staffInfo: staff 
    });
    
    Swal.close();
    
    if (res.success) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('u-name').innerText = res.user.name;
        document.getElementById('u-id').innerText = "ID: " + res.user.id;
        document.getElementById('u-dept').innerText = res.user.dept || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô";
        document.getElementById('u-time').innerText = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + res.user.time;
        document.getElementById('u-img').src = res.user.img || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        
        Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", res.user.name, "success");
        updateHistory(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    } else if (res.requireConfirm) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô Pop-up ‡∏ñ‡∏≤‡∏°
        const confirmRes = await Swal.fire({
            title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1',
            text: res.message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏•‡∏¢'
        });
        if (confirmRes.isConfirmed) {
            processAttendance(qrText, true);
        }
    } else {
        Swal.fire("‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤", res.message, "error");
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
async function updateHistory() {
    const res = await callGAS('getRecentRecords', { day: day });
    const list = document.getElementById('historyList'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ id="historyList" ‡πÉ‡∏ô HTML
    if (res.success && res.records.length > 0) {
        list.innerHTML = res.records.map(rec => `
            <div class="flex items-center gap-3 p-3 bg-white border-b">
                <div class="text-xs font-bold text-indigo-500">${rec.id}</div>
                <div class="flex-grow text-sm font-medium">${rec.name}</div>
                <div class="text-[10px] text-slate-400">${rec.time}</div>
            </div>
        `).join('');
    }
}

        function changeDay(d) {
            day = d;
            document.getElementById('d1').className = d === 1 ? "bg-indigo-600 text-white py-2 rounded-xl font-bold" : "py-2 rounded-xl font-bold";
            document.getElementById('d2').className = d === 2 ? "bg-indigo-600 text-white py-2 rounded-xl font-bold" : "py-2 rounded-xl font-bold";
        }

        window.onload = init;
    </script>
</body>
</html>
