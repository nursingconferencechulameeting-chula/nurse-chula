<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• 2569</title>

  <!-- CSS Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap">

  <style>
    :root {
      --primary-color: #004085;
      --secondary-color: #6610f2;
      --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f8f9fa 100%);
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      padding-top: 80px;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.9) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar-brand { font-weight: 800; color: var(--primary-color) !important; }

    .scanner-card {
      border: none;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      background: #fff;
    }

    .scanner-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px;
      text-align: center;
    }

    .scanner-container {
      position: relative;
      width: 100%;
      min-height: 400px;
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #reader {
      width: 100% !important;
      border: none !important;
    }

    #reader video {
      object-fit: cover !important;
      width: 100% !important;
    }

    .status-btn-group .btn {
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .result-card {
      border-left: 5px solid #198754;
      background-color: #f8fffb;
    }

    .tiny-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      font-weight: bold;
    }

    [v-cloak] { display: none; }
  </style>
</head>
<body>

  <div id="app" v-cloak>
    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fa-solid fa-qrcode me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2569
        </a>
      </div>
    </nav>

    <div class="container pb-5">
      <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">
          
          <div class="scanner-card animate__animated animate__fadeIn">
            <div class="scanner-header">
              <h4 class="mb-1 fw-bold">‡∏™‡πÅ‡∏Å‡∏ô QR Code</h4>
              <p class="mb-0 small opacity-75">‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå</p>
            </div>

            <div class="card-body p-4">
              
              <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
              <div class="mb-4 text-center">
                <label class="form-label d-block fw-bold text-muted mb-3">
                  <i class="fa-solid fa-calendar-day me-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </label>
                <div class="btn-group w-100 status-btn-group bg-light p-1 rounded-pill" role="group">
                  <button type="button" class="btn w-50" 
                          :class="scanDay === '1' ? 'btn-primary shadow' : 'btn-light text-muted'" 
                          @click="scanDay = '1'">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 (25 ‡∏™.‡∏Ñ.)
                  </button>
                  <button type="button" class="btn w-50" 
                          :class="scanDay === '2' ? 'btn-primary shadow' : 'btn-light text-muted'" 
                          @click="scanDay = '2'">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 (26 ‡∏™.‡∏Ñ.)
                  </button>
                </div>
              </div>

              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
              <div class="row g-2 mb-4">
                <div class="col-6">
                  <button v-if="!isScanning" class="btn btn-outline-primary w-100 py-3 rounded-4 shadow-sm" 
                          @click="startScanner" :disabled="loading">
                    <i class="fa-solid fa-camera mb-1 d-block fs-4"></i>
                    <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</span>
                  </button>
                  <button v-else class="btn btn-danger w-100 py-3 rounded-4 shadow-sm" 
                          @click="stopScanner">
                    <i class="fa-solid fa-video-slash mb-1 d-block fs-4"></i>
                    <span>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</span>
                  </button>
                </div>
                <div class="col-6">
                  <button class="btn btn-outline-secondary w-100 py-3 rounded-4 shadow-sm" 
                          @click="$refs.qrFileInput.click()" :disabled="loading">
                    <i class="fa-solid fa-image mb-1 d-block fs-4"></i>
                    <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</span>
                  </button>
                  <input type="file" ref="qrFileInput" class="d-none" accept="image/*" @change="handleQrUpload">
                </div>
              </div>

              <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô -->
              <div v-show="isScanning" class="scanner-container mb-4 shadow-inner">
                <div id="reader"></div>
              </div>

              <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô -->
              <div v-if="scannedUser" class="mt-4 animate__animated animate__zoomIn">
                <div class="card result-card border-0 shadow-sm p-3">
                  <div class="d-flex align-items-center gap-3">
                    <div class="flex-shrink-0">
                      <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fa-solid fa-check fs-4"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="fw-bold mb-0 text-success">{{ scannedUser.message }}</h5>
                      <p class="text-muted small mb-0">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ scanDay }})</p>
                    </div>
                    <button class="btn-close" @click="scannedUser = null"></button>
                  </div>
                </div>
              </div>

              <!-- Loading Indicator -->
              <div v-if="loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
              </div>

            </div>
          </div>

          <footer class="text-center text-muted small mt-5">
            <p>¬© 2026 ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå</p>
          </footer>

        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

  <script>
    const { createApp, ref, onMounted } = Vue;

    // üõë ‡∏£‡∏∞‡∏ö‡∏∏ URL Web App ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzfOu3S0v5_u0XJi-IdwTIx6HecySKswYFt05wjfCBbu5pyEYy2LPsFSUkL7d4dmdVK/exec";

    createApp({
      setup() {
        const isScanning = ref(false);
        const scanDay = ref('1');
        const scannedUser = ref(null);
        const loading = ref(false);
        let html5QrScanner = null;

        const startScanner = () => {
          scannedUser.value = null;
          isScanning.value = true;
          
          html5QrScanner = new Html5Qrcode("reader");
          const config = { fps: 10, qrbox: { width: 250, height: 250 } };

          html5QrScanner.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
              // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ QR Code
              processAttendance(decodedText);
              stopScanner();
            }
          ).catch(err => {
            console.error(err);
            Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "error");
            isScanning.value = false;
          });
        };

        const stopScanner = () => {
          if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
              isScanning.value = false;
            }).catch(err => console.error(err));
          }
        };

        const handleQrUpload = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          loading.value = true;
          const scanner = new Html5Qrcode("reader");
          scanner.scanFile(file, true)
            .then(decodedText => {
              processAttendance(decodedText);
              loading.value = false;
            })
            .catch(err => {
              Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ", "warning");
              loading.value = false;
            });
        };

        const processAttendance = async (qrText) => {
          loading.value = true;
          try {
            const response = await fetch(GAS_WEB_APP_URL, {
              method: "POST",
              body: JSON.stringify({
                action: 'recordAttendance',
                data: { text: qrText, day: scanDay.value }
              }),
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });

            const result = await response.json();
            loading.value = false;

            if (result.success) {
              scannedUser.value = { message: result.message };
              // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á Beep (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
              const audio = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3');
              audio.play();
            } else {
              Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", result.message, "warning");
            }
          } catch (error) {
            loading.value = false;
            Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "error");
          }
        };

        return {
          isScanning, scanDay, scannedUser, loading,
          startScanner, stopScanner, handleQrUpload
        };
      }
    }).mount('#app');
  </script>

</body>
</html>
