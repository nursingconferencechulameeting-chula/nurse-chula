<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Meeting Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
  --bg:#0f172a;
  --card:rgba(255,255,255,.1);
  --primary:#2563eb;
  --success:#22c55e;
  --danger:#ef4444;
  --text:#fff;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}

header{
  display:flex;
  justify-content:space-between;
  padding:12px 20px;
  background:#020617;
}

main{
  display:grid;
  grid-template-columns:1fr 1fr;
  height:calc(100vh - 120px);
}

.camera{
  position:relative;
}

#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.scan-frame{
  position:absolute;
  inset:20%;
  border:3px solid var(--success);
  border-radius:20px;
  box-shadow:0 0 0 999px rgba(0,0,0,.6);
}

.info{
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

.card{
  background:var(--card);
  backdrop-filter:blur(10px);
  border-radius:20px;
  padding:20px;
}

.user{
  display:flex;
  gap:15px;
  align-items:center;
}

.user img{
  width:80px;
  height:80px;
  border-radius:50%;
  object-fit:cover;
}

.history{
  max-height:300px;
  overflow:auto;
}

.history li{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
}

footer{
  display:flex;
  gap:10px;
  padding:10px;
  background:#020617;
}

button{
  flex:1;
  padding:15px;
  border:none;
  border-radius:14px;
  font-size:18px;
  background:var(--primary);
  color:white;
}

select{
  padding:10px;
  border-radius:10px;
}

@media(max-width:768px){
  main{
    grid-template-columns:1fr;
  }
  .info{
    position:absolute;
    bottom:80px;
    width:100%;
  }
}
</style>
</head>

<body>
<div id="app">
<header>
  <div>üì∑ QR Meeting Scanner</div>
  <div>{{ currentTime }}</div>
</header>

<main>
  <div class="camera">
    <div id="reader"></div>
    <div class="scan-frame" v-if="isScanning"></div>
  </div>

  <div class="info">
    <div class="card">
      <select v-model="scanDay">
        <option value="1">Day 1</option>
        <option value="2">Day 2</option>
      </select>

      <div class="user" v-if="scannedUser">
        <img :src="scannedUser.img || 'https://cdn-icons-png.flaticon.com/512/147/147144.png'">
        <div>
          <h2>{{ scannedUser.name }}</h2>
          <p>{{ scannedUser.dept }}</p>
          <span style="color:var(--success)">‚úÖ {{ scannedUser.time }}</span>
        </div>
      </div>

      <div v-else>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...</div>
    </div>

    <div class="card history">
      <h3>Recent</h3>
      <ul>
        <li v-for="r in recentHistory">{{ r.name }} - {{ r.time }}</li>
      </ul>
    </div>
  </div>
</main>

<footer>
  <button @click="startScanner">Start Scan</button>
  <button @click="stopScanner" style="background:var(--danger)">Stop</button>
</footer>
</div>

<script>
const {createApp,ref,onMounted} = Vue;

// üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfOu3S0v5_u0XJi-IdwTIx6HecySKswYFt05wjfCBbu5pyEYy2LPsFSUkL7d4dmdVK/exec";

createApp({
setup(){
  const isScanning = ref(false);
  const scanDay = ref("1");
  const scannedUser = ref(null);
  const recentHistory = ref([]);
  const currentTime = ref("");
  let html5Qr = null;
  let busy = false;

  setInterval(()=>{
    currentTime.value = new Date().toLocaleTimeString("th-TH");
  },1000);

  const startScanner = async()=>{
    if(busy) return;
    if(!html5Qr) html5Qr = new Html5Qrcode("reader");
    isScanning.value = true;
    await html5Qr.start(
      {facingMode:"environment"},
      {fps:10,qrbox:250},
      onScanSuccess
    );
  };

  const stopScanner = async()=>{
    if(html5Qr && html5Qr.isScanning){
      await html5Qr.stop();
      isScanning.value=false;
    }
  };

  const onScanSuccess = async(text)=>{
    if(busy) return;
    busy = true;
    await stopScanner();

    try{
      const res = await fetch(GAS_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"recordAttendance",
          data:{text,day:scanDay.value}
        })
      });
      const result = await res.json();

      if(result.success){
        scannedUser.value = result.user;
        recentHistory.value.unshift(result.user);
        if(recentHistory.value.length>10) recentHistory.value.pop();
        navigator.vibrate(200);
      }else{
        Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",result.message,"warning");
      }
    }catch{
      Swal.fire("Error","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ","error");
    }

    setTimeout(()=>{
      busy=false;
      startScanner();
    },3000);
  };

  const fetchHistory = async()=>{
    const res = await fetch(GAS_URL,{
      method:"POST",
      body:JSON.stringify({action:"getRecentRecords",data:{day:scanDay.value}})
    });
    const data = await res.json();
    if(data.success) recentHistory.value=data.records;
  };

  onMounted(fetchHistory);

  return{
    isScanning,scanDay,scannedUser,recentHistory,currentTime,
    startScanner,stopScanner
  };
}
}).mount("#app");
</script>
</body>
</html>
